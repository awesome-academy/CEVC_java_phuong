<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
  <meta charset="UTF-8">
  <title>Index Order Page</title>
  <th:block th:replace="~{admin/layouts/static :: css_links}"></th:block>
</head>

<body class="layout-fixed sidebar-expand-lg sidebar-open bg-body-tertiary">
  <!--begin::App Wrapper-->
  <div class="app-wrapper">
    <!--begin::Header-->
    <th:block th:replace="~{admin/layouts/header :: header}"></th:block>
    <!--end::Header-->
    <!--begin::Sidebar-->
    <th:block th:replace="~{admin/layouts/sidebar :: sidebar}"></th:block>
    <!--end::Sidebar-->
    <!--begin::App Main-->
    <main class="app-main">
      <!--begin::App Content Header-->
      <div class="app-content-header">
        <!--begin::Container-->
        <div class="container-fluid">
          <!--begin::Row-->
          <div class="row">
            <div class="col-sm-6">
              <h3 class="mb-0">Index</h3>
            </div>
          </div>
          <!--end::Row-->
        </div>
        <!--end::Container-->
      </div>
      <!--end::App Content Header-->
      <!--begin::App Content-->
      <div class="app-content">
        <!--begin::Container-->
        <div class="container-fluid">
          <!--begin::Row-->
          <div class="row">
            <!-- /.col -->
            <div class="col-md-12">
              <!-- /.card -->
              <div class="card">
                <div class="card-header">
                  <div class="row">
                    <div class="col-sm-6">
                      <form th:action="@{/admin/orders}" th:object="${search}" method="get">
                        <div class="d-flex gap-4 align-items-center">
                          <div class="filter-box d-flex gap-2 align-items-center">
                            <div>Filter by:</div>
                            <div>
                              <input type="text" class="form-control" placeholder="Input product name..."
                                name="productName" th:value="*{productName}" />
                            </div>
                            <div>
                              <select class="form-select" th:field="*{orderStatusId}">
                                <option value="">--Order Status--</option>
                                <option th:each="orderStatus : ${orderStatuses}" th:value="${orderStatus.id}"
                                  th:text="${orderStatus.name}">
                                </option>
                              </select>
                            </div>
                            <div>
                              <select class="form-select" th:field="*{priceLevel}">
                                <option value="">--Total Price Level--</option>
                                <option value="1">
                                  < 100.000</option>
                                <option value="2">100.000 - 1.000.000</option>
                                <option value="3">> 1.000.000</option>
                              </select>
                            </div>
                          </div>
                          <button class="btn btn-secondary" type="submit">Search</button>
                        </div>
                      </form>
                    </div>
                  </div>
                </div>
                <!-- /.card-header -->
                <div class="card-body p-0">
                  <table class="table table-striped">
                    <thead>
                      <tr>
                        <th style="width: 10px">ID</th>
                        <th>User Order Info</th>
                        <th>User Receiver Info</th>
                        <th>Product(Quantity)</th>
                        <th>Total price</th>
                        <th style="width: 150px">Order status</th>
                        <th>Created At</th>
                        <th class="text-center">Actions</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr class="align-middle" th:each="order, iterStat : ${orders}">
                        <td>
                          <a th:href="@{/admin/orders/{id}(id=${order.id})}" th:text="${order.id}"></a>
                        </td>
                        <td th:text="${order.user?.fullName}"></td>
                        <td>
                          <span th:if="${order.orderAddress != null}">
                            <span th:text="${order.orderAddress?.receiverName + ' - '}"></span>
                            <span th:text="${order.orderAddress?.phoneNumber + ' - '}"></span>
                            <span
                              th:text="${order.orderAddress?.streetAddress} + ', ' + ${order.orderAddress?.district} + ', ' + ${order.orderAddress?.city}"></span>
                          </span>
                        </td>
                        <td>
                          <span th:each="item, itemStat : ${order.orderItems}">
                            <span th:text="${item.product?.name} + ' (x' + ${item.quantity} + ')'"></span>
                            <span th:if="${!itemStat.last}">, </span>
                          </span>
                        </td>
                        <td th:text="${order.totalPrice}"></td>
                        <td>
                          <span class="badge" th:classappend="
                              ${order.orderStatus.name == 'COMPLETED' ? ' text-bg-success' :
                              (order.orderStatus.name == 'CANCELLED' ? ' text-bg-danger' : ' text-bg-secondary')}
                            ">
                            <span th:text="${order.orderStatus.name}"></span>
                          </span>
                        </td>
                        <td th:text="${order.createdAt}"></td>
                        <td class="text-center">
                          <button type="button" class="btn btn-primary" data-bs-toggle="modal"
                            data-bs-target="#updateStatusModal"
                            th:if="${order.orderStatus.name != 'COMPLETED' && order.orderStatus.name != 'CANCELLED'}"
                            th:data-order-id="${order.id}" th:data-current-status-id="${order.orderStatus.id}"
                            th:data-order-reason-cancel="${order.reasonCancel}">
                            Update status
                          </button>
                          <span
                            th:if="${order.orderStatus.name == 'COMPLETED' || order.orderStatus.name == 'CANCELLED'}">---</span>
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div>
                <!-- /.card-body -->
                <div class="card-footer">
                  <div class="row">
                    <div class="col-sm-6">
                      <form th:action="@{/admin/orders}" th:object="${search}" method="get" id="perPageForm">
                        <input type="hidden" name="productName" th:value="${search.productName}" />
                        <input type="hidden" name="orderStatus" th:value="${search.orderStatusId}" />
                        <input type="hidden" name="priceLevel" th:value="${search.priceLevel}" />
                        <div class="per-page-box d-flex gap-2 align-items-center">
                          <div>Per page:</div>
                          <div>
                            <select class="form-select form-select-sm" name="perPage"
                              onchange="document.getElementById('perPageForm').submit()">
                              <option value="5" th:selected="*{perPage} == 5">5</option>
                              <option value="10" th:selected="*{perPage} == 10">10</option>
                              <option value="15" th:selected="*{perPage} == 15">15</option>
                            </select>
                          </div>
                        </div>
                      </form>
                    </div>
                    <div class="col-sm-6">
                      <ul class="pagination pagination-sm float-end" th:if="${totalPages > 1}">
                        <li class="page-item" th:classappend="${search.page} == ${1} ? 'disabled'">
                          <a class="page-link"
                            th:href="@{/admin/orders(page=${search.page - 1}, perPage=${search.perPage}, productName=${search.productName}, orderStatus=${search.orderStatusId}, priceLevel=${search.priceLevel})}">&laquo;</a>
                        </li>
                        <li class="page-item" th:each="i : ${#numbers.sequence(0, totalPages-1)}"
                          th:classappend="${i + 1} == ${search.page} ? 'active'">
                          <a class="page-link"
                            th:href="@{/admin/orders(page=${i + 1}, perPage=${search.perPage}, productName=${search.productName}, orderStatus=${search.orderStatusId}, priceLevel=${search.priceLevel})}"
                            th:text="${i + 1}">
                          </a>
                        </li>
                        <li class="page-item" th:classappend="${search.page} == ${totalPages} ? 'disabled'">
                          <a class="page-link"
                            th:href="@{/admin/orders(page=${search.page + 1}, perPage=${search.perPage}, productName=${search.productName}, orderStatus=${search.orderStatusId}, priceLevel=${search.priceLevel})}">
                            &raquo;
                          </a>
                        </li>
                      </ul>
                    </div>
                  </div>
                </div>
              </div>
              <!-- /.card -->
            </div>
            <!-- /.col -->
          </div>
          <!--end::Row-->
        </div>
        <!--end::Container-->
      </div>
      <!--end::App Content-->
    </main>
    <!--end::App Main-->
    <!--begin::Footer-->
    <th:block th:replace="~{admin/layouts/footer :: footer}"></th:block>
    <!--end::Footer-->
  </div>
  <div class="modal fade" id="updateStatusModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1"
    aria-labelledby="updateStatusModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h1 class="modal-title fs-5" id="updateStatusModalLabel">Update Status</h1>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form action="#" method="post" id="updateStatusForm">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
            <div class="mb-3" id="statusDiv">
              <label for="statusSelect" class="form-label">Order Status</label>
              <select class="form-select" name="orderStatusId" id="statusSelect">
                <option th:each="status : ${orderStatuses}" th:value="${status.id}" th:text="${status.name}">
                </option>
              </select>
            </div>
            <div class="mb-3 d-none" id="reasonCancelDiv">
              <label for="reasonCancelTextarea" class="form-label">Reason Cancel</label>
              <textarea class="form-control" rows="5" name="reasonCancel" id="reasonCancelTextarea"
                placeholder="Input reason cancel"></textarea>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="submit" class="btn btn-primary" form="updateStatusForm">Update</button>
        </div>
      </div>
    </div>
  </div>
  <!--end::App Wrapper-->
  <!--begin::Script-->
  <!--begin::Third Party Plugin(OverlayScrollbars)-->
  <th:block th:replace="~{admin/layouts/static :: js_scripts}"></th:block>
  <script th:src="@{/js/update-order-status.js}"></script>
  <!--end::OverlayScrollbars Configure-->
  <!-- OPTIONAL SCRIPTS -->
  <!-- sortablejs -->
  <!--end::Script-->
</body>

</html>
